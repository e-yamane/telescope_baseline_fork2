runs:
  using: "Composite"
  steps:
#    - name: checkout Pages branch
#      uses: actions/checkout@v3
#      with:
#        ref: gh-pages
#        path: pages
#      id: check_out_pages_branch
#      continue-on-error: true

    - name: Test with pytest
      env:
        BRANCH: ${{ github.ref_name}}
      id: pytest
      continue-on-error: true
      run: |
        python -m pip install pytest pytest-html pytest-cov
        pushd src
        python -m pytest ../tests --junitxml=../pages/test_report/$BRANCH/pytest.xml --html=../pages/test_report/$BRANCH/pytest.html --cov=. --cov-branch --cov-report=term-missing --cov-report=html
        rm htmlcov/.gitignore
        rm -rf ../pages/test_report/$BRANCH/htmlcov
        mv htmlcov ../pages/test_report/$BRANCH/
        ls -al
        popd
      shell: bash

    - name: Send Coverage Report to CodeClimate
#      if: ${{ steps.pytest.outcome == 'success' }}
    　　　　uses: paambaati/codeclimate-action@v3.0.0
      env:
        CC_TEST_REPORTER_ID: ecca14ba459b9f22f9a95816b496271974cd4c6155fc8a374facf07f6b79e7ef
      with:
        debug: true
        coverageLocations: src/.coverage:coverage.py
    

#    - name: Generate Test Report Index
#      env:
#        BRANCH: ${{ github.ref_name}}
#        REPOSITORY: ${{ github.repository}}
#      run: |
#        pushd pages/test_report
#        echo "<html><head><title>JASMINE Testing Report</title></head><body><h1>JASMINE TESTING REPORT</h1><ul>" > index.html
#        find . -name pytest.html | xargs -Ixxx dirname xxx | awk '{print substr($0, 3)}' | xargs -Ixxx echo "<li><a href=\"https://github.com/$REPOSITORY/actions/workflows/pytest.yml?query=branch:xxx\"><img src=\"https://github.com/$REPOSITORY/actions/workflows/pytest.yml/badge.svg?branch=xxx\" alt=\"pytest\" style=\"max-width: 100%;\"></a>xxx<a href=\"xxx/pytest.html\">(Test Report)</a><a href=\"xxx/htmlcov/index.html\">(Test Coverage Report)</a></li>" >> index.html
#        echo "</ul></body></html>" >> index.html
#        popd
#      shell: bash

#    - name: Publish Test Report
#      uses: peaceiris/actions-gh-pages@v3
#      with:
#        github_token: ${{ env.GITHUB_TOKEN }}
#        publish_dir: ./pages

    - name: Notice Error
      if: ${{ steps.pytest.outcome == 'failure' }}
      run: exit 1
      shell: bash
